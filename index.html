<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>公文助手 - 惇陽工程</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 15px; margin: 0; color: #333; }
        .container { max-width: 950px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .upload-section { background: #eef2f7; padding: 20px; border: 2px dashed #3498db; border-radius: 8px; margin-bottom: 20px; }
        .mode-selector { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .mode-btn { flex: 1; padding: 15px 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: #fff; font-weight: bold; transition: 0.3s; min-width: 80px; }
        .mode-btn.active { background: #3498db; color: white; border-color: #3498db; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        .level-container { margin-bottom: 15px; border-left: 4px solid #2c3e50; padding-left: 12px; background: #fafafa; padding-top: 10px; padding-bottom: 10px; }
        .sub-level-box { margin-left: 15px; margin-top: 10px; border-left: 2px dashed #3498db; padding-left: 10px; }
        .item-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        button { min-height: 44px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
        .btn-l1 { background: #2c3e50; color: white; width: 100%; margin-bottom: 15px; }
        .btn-l2 { background: #3498db; color: white; font-size: 14px; margin: 5px 0; padding: 5px 15px; }
        .btn-l3 { background: #7f8c8d; color: white; font-size: 12px; padding: 4px 10px; }
        .btn-del { background: #e74c3c; color: white; padding: 5px 10px; }
        .generate-btn { background-color: #27ae60; color: white; font-size: 18px; width: 100%; margin-top: 20px; }
        .output-area { margin-top: 25px; padding: 15px; background: #fffbe6; border: 1px solid #ffe58f; display: none; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0;">🏛️ 監造公文助手</h2>
        <small style="color:#666;">惇陽工程顧問 AI 實驗室</small>
    </div>

    <div class="upload-section">
        <label>📸 AI 文號辨識 (重新辨識請再次上傳)</label>
        <input type="file" id="fileInput" accept="image/*,application/pdf" onclick="this.value=null">
        <div id="loader" style="display:none; color:#d35400; font-weight:bold; margin-top:10px; font-size: 14px;">⚙️ 正在精準分析文號...</div>
    </div>

    <div class="mode-selector">
        <button class="mode-btn active" id="modeUp" onclick="setMode('up', this)">對上級</button>
        <button class="mode-btn" id="modeEqual" onclick="setMode('equal', this)">對平級</button>
        <button class="mode-btn" id="modeDown" onclick="setMode('down', this)">對下級</button>
    </div>

    <div class="form-group">
        <label>常用情境快選</label>
        <select id="scenarioSelect" onchange="applyScenario()">
            <option value="">-- 手動關鍵字撰寫 --</option>
        </select>
    </div>

    <div class="form-group">
        <label>工程名稱</label>
        <input type="text" id="projectName" value="中和區錦和運動公園整體規劃改善工程">
    </div>
    
    <div class="form-group">
        <label>受文單位</label>
        <input type="text" id="recipient" placeholder="受文單位名稱">
    </div>
    <div class="form-group">
        <label>來文字號 (自動提取)</label>
        <input type="text" id="refNum" placeholder="辨識結果將在此顯示">
    </div>

    <div class="form-group">
        <label>公文主旨關鍵字</label>
        <input type="text" id="subjectInp">
    </div>

    <div class="form-group">
        <label>說明內容階層 ( 一. → (一) → 1. )</label>
        <div id="l1-root"></div>
        <button class="btn-l1" onclick="addL1()">＋ 增加大項 一、</button>
    </div>

    <button class="generate-btn" onclick="generateDoc()">🛠️ 產生正式公文全文</button>

    <div id="outputArea" class="output-area">
        <div id="finalResult" style="white-space: pre-wrap; background: white; padding: 15px; border: 1px solid #ddd; font-size: 16px; line-height:1.6; overflow-x: auto;"></div>
        <button style="background:#3498db; color:white; width:100%; margin-top:10px;" onclick="copyContent()">📋 複製全文</button>
    </div>
</div>

<script>
    // PWA 註冊邏輯
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('PWA Sw Error', err));
        });
    }

    let currentMode = 'up';
    const chineseNums = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
    const scenarios = {
        up: [
            { title: "提報監造月報", sub: "115年x月份監造月報案", data: [{ l1: "檢附旨揭工程本月份監造月報計1式3份。", l2: [{ l2: "內容包含施工進度彙整、品質抽查及勞安巡查紀錄。", l3: ["實際進度：xx.xx%"] }] }] },
            { title: "提報估驗計價", sub: "第x期估驗計價審核案", data: [{ l1: "施工廠商已依約完成本階段施作，經核實符合計價條件。", l2: [{ l2: "本期申報金額：新台幣XXX元整。", l3: ["檢附計價明細表"] }] }] }
        ],
        equal: [
            { title: "管線遷移協調", sub: "管線妨礙施工辦理遷移協調案", data: [{ l1: "現場發現電信/電力管線與設計位置衝突。", l2: [{ l2: "請 貴單位配合辦理遷移作業。", l3: ["衝突地點：K0+XXX"] }] }] }
        ],
        down: [
            { title: "限期改善缺失", sub: "現場安全缺失限期改善通知案", data: [{ l1: "本司巡查發現下列缺失，請 貴司於3日內改善：", l2: [{ l2: "安衛防護不周。", l3: ["施工圍籬倒塌", "警示燈故障"] }] }] }
        ]
    };

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    document.getElementById('fileInput').addEventListener('change', async function() {
        const file = this.files[0]; if (!file) return;
        const loader = document.getElementById('loader'); const refNumInp = document.getElementById('refNum');
        loader.style.display = 'block'; refNumInp.value = ""; 
        try {
            let text = "";
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                const content = await page.getTextContent();
                text = content.items.map(s => s.str).join('');
            } else {
                const result = await Tesseract.recognize(file, 'chi_tra'); text = result.data.text;
            }
            let cleanText = text.replace(/[\s：:：]/g, '');
            const commonTerms = { "殯域": "殯墓", "北市殯域": "北市殯墓", "殯域字": "殯墓字" };
            for (let [wrong, right] of Object.entries(commonTerms)) { cleanText = cleanText.replace(new RegExp(wrong, 'g'), right); }
            const match = cleanText.match(/[\u4e00-\u9fa5]+字第\d+號/);
            if(match) {
                let finalNum = match[0];
                if (finalNum.includes("發文字號")) finalNum = finalNum.split("發文字號")[1];
                else if (finalNum.includes("日發文")) finalNum = finalNum.split("日發文")[1];
                refNumInp.value = finalNum;
                loader.innerHTML = "✅ 辨識完成";
            } else { loader.innerHTML = "⚠️ 未偵測到格式"; }
        } catch (e) { loader.innerText = "❌ 辨識失敗"; }
    });

    function addL1(text = "") {
        const root = document.getElementById('l1-root');
        const div = document.createElement('div');
        div.className = 'level-container';
        div.innerHTML = `<div class="item-row"><span class="l1-label" style="font-weight:bold"></span><input type="text" class="l1-input" value="${text}"><button class="btn-del" onclick="this.parentElement.parentElement.remove(); updateAllLabels();">刪除</button></div><div class="sub-container"></div><button class="btn-l2" onclick="addL2(this)">＋ 增加中項 (一)</button>`;
        root.appendChild(div); updateAllLabels(); return div;
    }

    function addL2(btn, text = "") {
        const container = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'sub-level-box';
        div.innerHTML = `<div class="item-row"><span class="l2-label"></span><input type="text" class="l2-input" value="${text}"><button class="btn-del" onclick="this.parentElement.parentElement.remove(); updateAllLabels();">刪除</button></div><div class="sub-sub-container"></div><button class="btn-l3" onclick="addL3(this)">＋ 增加細項 1.</button>`;
        container.appendChild(div); updateAllLabels(); return div;
    }

    function addL3(btn, text = "") {
        const container = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<span class="l3-label"></span><input type="text" class="l3-input" value="${text}"><button class="btn-del" onclick="this.parentElement.remove(); updateAllLabels();">刪除</button>`;
        container.appendChild(div); updateAllLabels(); return div;
    }

    function updateAllLabels() {
        document.querySelectorAll('.level-container').forEach((l1, i) => {
            l1.querySelector('.l1-label').innerText = `${chineseNums[i]}、`;
            l1.querySelectorAll('.sub-level-box').forEach((l2, j) => {
                l2.querySelector('.l2-label').innerText = `(${chineseNums[j]})`;
                l2.querySelectorAll('.l3-input').forEach((l3, k) => { l3.previousElementSibling.innerText = `${k+1}.`; });
            });
        });
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const select = document.getElementById('scenarioSelect');
        select.innerHTML = '<option value="">-- 手動撰寫 --</option>';
        scenarios[mode].forEach((s, i) => select.innerHTML += `<option value="${i}">${s.title}</option>`);
    }

    function applyScenario() {
        const idx = document.getElementById('scenarioSelect').value;
        if (idx === "") return;
        const s = scenarios[currentMode][idx];
        document.getElementById('subjectInp').value = s.sub;
        document.getElementById('l1-root').innerHTML = ""; 
        s.data.forEach(d1 => {
            const l1Div = addL1(d1.l1);
            d1.l2.forEach(d2 => {
                const l2Div = addL2(l1Div.querySelector('.btn-l2'), d2.l2);
                d2.l3.forEach(d3 => addL3(l2Div.querySelector('.btn-l3'), d3));
            });
        });
    }

    function generateDoc() {
        const proj = document.getElementById('projectName').value;
        const recipient = document.getElementById('recipient').value || "受文者";
        const ref = document.getElementById('refNum').value;
        const subK = document.getElementById('subjectInp').value;
        const year = new Date().getFullYear()-1911;
        let bodyText = "";
        document.querySelectorAll('.level-container').forEach((l1, i) => {
            const val = l1.querySelector('.l1-input').value;
            if(val) {
                bodyText += `\n${chineseNums[i]}、${val}`;
                l1.querySelectorAll('.sub-level-box').forEach((l2, j) => {
                    const val2 = l2.querySelector('.l2-input').value;
                    if(val2) { bodyText += `\n    (${chineseNums[j]})${val2}`; l2.querySelectorAll('.l3-input').forEach((l3, k) => { if(l3.value) bodyText += `\n        ${k+1}.${l3.value}`; }); }
                });
            }
        });
        const subject = (currentMode === 'up') ? `有關「${proj}」${subK}案，報請  鑒核。` : `有關「${proj}」${subK}案，請  查照。`;
        const res = `發文者：惇陽工程顧問有限公司\n發文日期：中華民國 ${year}年${new Date().getMonth()+1}月${new Date().getDate()}日\n發文字號：惇陽監字第${year}0001號\n受文者：${recipient}\n\n主旨：${subject}\n\n說明：${ref ? '\n一、復  貴單位'+ref+'辦理。' : ''}${bodyText}`;
        document.getElementById('finalResult').innerText = res;
        document.getElementById('outputArea').style.display = 'block';
    }

    function copyContent() {
        navigator.clipboard.writeText(document.getElementById('finalResult').innerText);
        alert('已複製到剪貼簿！');
    }

    setMode('up', document.getElementById('modeUp'));
    addL1();
</script>
</body>
</html>