<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å…¬æ–‡æ™ºèƒ½åŠ©æ‰‹ - æƒ‡é™½å·¥ç¨‹é¡§å•</title>
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px; }
        .upload-section { background: #eef2f7; padding: 15px; border: 2px dashed #3498db; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: #fff; font-weight: bold; transition: 0.3s; }
        .mode-btn.active { background: #3498db; color: white; border-color: #3498db; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .level-container { margin-bottom: 15px; border-left: 4px solid #2c3e50; padding-left: 15px; background: #fafafa; padding: 10px; border-radius: 0 8px 8px 0; }
        .sub-level-box { margin-left: 20px; margin-top: 10px; border-left: 2px dashed #3498db; padding-left: 10px; }
        .sub-sub-container { margin-left: 30px; margin-top: 5px; }
        .item-row { display: flex; gap: 8px; margin-bottom: 5px; align-items: center; }
        .btn-l1 { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 15px; width: 100%; }
        .btn-l2 { background: #3498db; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin: 5px 0;}
        .btn-l3 { background: #7f8c8d; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-del { background: #e74c3c; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .generate-btn { background-color: #27ae60; color: white; padding: 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 20px; width: 100%; margin-top: 20px; font-weight: bold; }
        .output-area { margin-top: 30px; padding: 25px; background: #fffbe6; border: 1px solid #ffe58f; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ›ï¸ ç›£é€ å…¬æ–‡åŠ©æ‰‹ <span style="font-size: 0.5em; color: #666;">æƒ‡é™½å·¥ç¨‹é¡§å• - æƒ…å¢ƒæ•´åˆå¼·åŒ–ç‰ˆ</span></h2>
    </div>

    <div class="upload-section">
        <label>ğŸ“¸ AI æ–‡è™Ÿè¾¨è­˜ (é‡æ–°è¾¨è­˜è«‹å†æ¬¡ä¸Šå‚³æª”æ¡ˆ)</label>
        <input type="file" id="fileInput" accept="image/*,application/pdf" onclick="this.value=null">
        <div id="loader" style="display:none; color:#d35400; font-weight:bold; margin-top:10px;">âš™ï¸ æ­£åœ¨ç²¾æº–åˆ†ææ–‡è™Ÿä¸­...</div>
    </div>

    <label>ç™¼æ–‡å°è±¡æ¨¡å¼</label>
    <div class="mode-selector">
        <button class="mode-btn active" id="modeUp" onclick="setMode('up', this)">å°ä¸Šç´š (æ©Ÿé—œ)</button>
        <button class="mode-btn" id="modeEqual" onclick="setMode('equal', this)">å°å¹³ç´š (å¹³è¡Œå–®ä½)</button>
        <button class="mode-btn" id="modeDown" onclick="setMode('down', this)">å°ä¸‹ç´š (å» å•†)</button>
    </div>

    <div class="form-group">
        <label>å¸¸ç”¨æƒ…å¢ƒå¿«é¸ (è‡ªå‹•å¸¶å…¥å°ˆæ¥­ç¯„æœ¬)</label>
        <select id="scenarioSelect" onchange="applyScenario()">
            <option value="">-- æ‰‹å‹•é—œéµå­—æ’°å¯« --</option>
        </select>
    </div>

    <div class="form-group">
        <label>å·¥ç¨‹åç¨±</label>
        <input type="text" id="projectName" value="ä¸­å’Œå€éŒ¦å’Œé‹å‹•å…¬åœ’æ•´é«”è¦åŠƒæ”¹å–„å·¥ç¨‹">
    </div>
    
    <div style="display:flex; gap:10px;" class="form-group">
        <div style="flex:1">
            <label>å—æ–‡å–®ä½</label>
            <input type="text" id="recipient" placeholder="å—æ–‡å–®ä½åç¨±">
        </div>
        <div style="flex:1">
            <label>ä¾†æ–‡å­—è™Ÿ (è¾¨è­˜è‡ªå‹•æå–)</label>
            <input type="text" id="refNum" placeholder="è¾¨è­˜çµæœå°‡åœ¨æ­¤é¡¯ç¤º">
        </div>
    </div>

    <div class="form-group">
        <label>å…¬æ–‡ä¸»æ—¨é—œéµå­—</label>
        <input type="text" id="subjectInp" placeholder="ä¾‹å¦‚ï¼šå ±è«‹é–‹å·¥å‚™æŸ¥">
    </div>

    <div class="form-group">
        <label>èªªæ˜å…§å®¹éšå±¤ç·¨è¼¯ ( ä¸€ã€ â†’ (ä¸€) â†’ 1. )</label>
        <div id="l1-root"></div>
        <button class="btn-l1" onclick="addL1()">ï¼‹ å¢åŠ èªªæ˜å¤§é … (ä¸€ã€äºŒã€ä¸‰...)</button>
    </div>

    <button class="generate-btn" onclick="generateDoc()">ğŸ› ï¸ ç”¢ç”Ÿæ­£å¼å…¬æ–‡å…¨æ–‡</button>

    <div id="outputArea" class="output-area">
        <div id="finalResult" style="white-space: pre-wrap; background: white; padding: 25px; border: 1px solid #ddd; font-size: 17px; line-height:1.8;"></div>
        <button style="background:#3498db; color:white; border:none; padding:12px; width:100%; cursor:pointer; margin-top:15px; font-size:16px; border-radius:4px;" onclick="copyContent()">ğŸ“‹ è¤‡è£½å…¬æ–‡å…¨æ–‡</button>
    </div>
</div>

<script>
    let currentMode = 'up';
    const chineseNums = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];

    const scenarios = {
        up: [
            { title: "æå ±ç›£é€ æœˆå ±", sub: "115å¹´xæœˆä»½ç›£é€ æœˆå ±æ¡ˆ", data: [{ l1: "æª¢é™„æ—¨æ­å·¥ç¨‹æœ¬æœˆä»½ç›£é€ æœˆå ±è¨ˆ1å¼3ä»½ã€‚", l2: [{ l2: "å…§å®¹åŒ…å«æ–½å·¥é€²åº¦å½™æ•´ã€å“è³ªæŠ½æŸ¥åŠå‹å®‰å·¡æŸ¥ç´€éŒ„ã€‚", l3: ["å¯¦éš›é€²åº¦ï¼šxx.xx%", "é å®šé€²åº¦ï¼šxx.xx%"] }] }] },
            { title: "ç”³è«‹ä¼°é©—è¨ˆåƒ¹", sub: "ç¬¬xæœŸä¼°é©—è¨ˆåƒ¹å¯©æ ¸æ¡ˆ", data: [{ l1: "æ–½å·¥å» å•†å·²ä¾ç´„å®Œæˆæœ¬éšæ®µæ–½ä½œå…§å®¹ï¼Œç¶“æ ¸å¯¦ç¬¦åˆè¨ˆåƒ¹æ¢ä»¶ã€‚", l2: [{ l2: "æœ¬æœŸç”³å ±é‡‘é¡ï¼šæ–°å°å¹£XXXå…ƒæ•´ã€‚", l3: ["æª¢é™„ä¼°é©—æ˜ç´°è¡¨åŠç›¸é—œä½è­‰ç…§ç‰‡"] }] }] },
            { title: "æå ±é–‹å·¥å‚™æŸ¥", sub: "æœ¬å·¥ç¨‹å ±è«‹é–‹å·¥å‚™æŸ¥æ¡ˆ", data: [{ l1: "æ–½å·¥å» å•†å·²å®Œæˆé–‹å·¥å‰å„é …æº–å‚™å·¥ä½œï¼Œæ“¬è‡ª115å¹´xæœˆxæ—¥æ­£å¼é–‹å·¥ã€‚", l2: [{ l2: "æª¢é™„é–‹å·¥å ±å‘Šã€äººå“¡ç·¨çµ„è¡¨åŠå‹å®‰ä¿éšªå–®ã€‚", l3: [] }] }] },
            { title: "è¨ˆç•«æ›¸æ ¸å®šå‚™æŸ¥", sub: "æ–½å·¥(å“è³ª)è¨ˆç•«æ›¸å¯©æŸ¥å®Œç•¢å‚™æŸ¥æ¡ˆ", data: [{ l1: "æ—¨æ­è¨ˆç•«æ›¸ç¶“æœ¬å¸å¯©æŸ¥ï¼Œç›¸é—œå…§å®¹å·²ç¬¦åˆå¥‘ç´„è¦ç¯„è¦æ±‚ã€‚", l2: [{ l2: "æ“¬äºˆåŒæ„æ ¸å‚™ã€‚", l3: [] }] }] }
        ],
        equal: [
            { title: "ç®¡ç·šé·ç§»å”èª¿", sub: "ç®¡ç·šå¦¨ç¤™æ–½å·¥è¾¦ç†é·ç§»å”èª¿æ¡ˆ", data: [{ l1: "ç¶“ç¾å ´å‹˜æŸ¥ï¼Œæ–½å·¥ç¯„åœå…§ç™¼ç¾ç®¡ç·šèˆ‡è¨­è¨ˆä½ç½®è¡çªã€‚", l2: [{ l2: "è«‹ è²´å–®ä½é…åˆè¾¦ç†é·ç§»ä½œæ¥­ã€‚", l3: ["è¡çªåœ°é»ï¼šK0+XXXè™•", "ç®¡ç·šé¡å‹ï¼šé›»ä¿¡/é›»åŠ›"] }] }] }
        ],
        down: [
            { title: "é™æœŸæ”¹å–„ç¼ºå¤±", sub: "ç¾å ´å®‰å…¨ç¼ºå¤±é™æœŸæ”¹å–„é€šçŸ¥æ¡ˆ", data: [{ l1: "æœ¬å¸æ–¼ç¾å ´å·¡æŸ¥ç™¼ç¾ä¸‹åˆ—ç¼ºå¤±ï¼Œè«‹ è²´å¸æ–¼3æ—¥å…§æ”¹å–„ï¼š", l2: [{ l2: "å®‰è¡›é˜²è­·ä¸å‘¨ã€‚", l3: ["æ–½å·¥åœç±¬å€’å¡Œ", "äº¤é€šéŒé–“è·éå¤§"] }] }] }
        ]
    };

    // è¾¨è­˜é‚è¼¯å„ªåŒ–èˆ‡è‡ªå‹•æ ¡æ­£
    document.getElementById('fileInput').addEventListener('change', async function() {
        const file = this.files[0]; if (!file) return;
        const loader = document.getElementById('loader'); const refNumInp = document.getElementById('refNum');
        loader.style.display = 'block'; loader.innerText = "âš™ï¸ æ­£åœ¨ç²¾æº–åˆ†ææ–‡è™Ÿä¸­..."; refNumInp.value = ""; 
        
        try {
            let text = "";
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                const content = await page.getTextContent();
                text = content.items.map(s => s.str).join('');
            } else {
                const result = await Tesseract.recognize(file, 'chi_tra'); text = result.data.text;
            }

            // 1. åŸºæœ¬æ¸…ç†
            let cleanText = text.replace(/[\sï¼š:ï¼š]/g, '');

            // 2. é‡å°å·¥ç¨‹/å…¬æ–‡æ˜“éŒ¯å­—é€²è¡Œæ‰‹å‹•æ ¡æ­£ (ä¾‹å¦‚ åŸŸ->å¢“, æ®¯åŸŸ->æ®¯å¢“)
            const commonTerms = {
                "æ®¯åŸŸ": "æ®¯å¢“",
                "åŒ—å¸‚æ®¯åŸŸ": "åŒ—å¸‚æ®¯å¢“",
                "æ®¯åŸŸå­—": "æ®¯å¢“å­—"
            };
            for (let [wrong, right] of Object.entries(commonTerms)) {
                cleanText = cleanText.replace(new RegExp(wrong, 'g'), right);
            }

            // 3. æŠ“å–æ¨™æº–å­—è™Ÿæ ¼å¼
            const match = cleanText.match(/[\u4e00-\u9fa5]+å­—ç¬¬\d+è™Ÿ/);
            if(match) {
                let finalNum = match[0];
                if (finalNum.includes("ç™¼æ–‡å­—è™Ÿ")) finalNum = finalNum.split("ç™¼æ–‡å­—è™Ÿ")[1];
                else if (finalNum.includes("æ—¥ç™¼æ–‡")) finalNum = finalNum.split("æ—¥ç™¼æ–‡")[1];
                
                refNumInp.value = finalNum;
                loader.innerHTML = `<span style="color:#27ae60;">âœ… è¾¨è­˜æˆåŠŸï¼š${finalNum}</span>`;
            } else { loader.innerHTML = `âš ï¸ æœªåµæ¸¬åˆ°æ¨™æº–æ–‡è™Ÿæ ¼å¼ï¼Œè«‹æ‰‹å‹•æ ¡æ­£ã€‚`; }
        } catch (e) { loader.innerText = "âŒ è¾¨è­˜å‡ºéŒ¯ã€‚"; }
    });

    function addL1(text = "") {
        const root = document.getElementById('l1-root');
        const div = document.createElement('div');
        div.className = 'level-container';
        div.innerHTML = `
            <div class="item-row"><span class="l1-label" style="font-weight:bold"></span><input type="text" class="l1-input" value="${text}"><button class="btn-del" onclick="this.parentElement.parentElement.remove(); updateAllLabels();">åˆªé™¤</button></div>
            <div class="sub-container"></div>
            <button class="btn-l2" style="margin-left:25px" onclick="addL2(this)">ï¼‹ å¢åŠ ä¸­é … (ä¸€)</button>
        `;
        root.appendChild(div);
        updateAllLabels();
        return div;
    }

    function addL2(btn, text = "") {
        const container = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'sub-level-box';
        div.innerHTML = `
            <div class="item-row"><span class="l2-label"></span><input type="text" class="l2-input" value="${text}"><button class="btn-del" onclick="this.parentElement.parentElement.remove(); updateAllLabels();">åˆªé™¤</button></div>
            <div class="sub-sub-container"></div>
            <button class="btn-l3" style="margin-left:35px" onclick="addL3(this)">ï¼‹ å¢åŠ ç´°é … 1.</button>
        `;
        container.appendChild(div);
        updateAllLabels();
        return div;
    }

    function addL3(btn, text = "") {
        const container = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<span class="l3-label"></span><input type="text" class="l3-input" value="${text}"><button class="btn-del" onclick="this.parentElement.remove(); updateAllLabels();">åˆªé™¤</button>`;
        container.appendChild(div);
        updateAllLabels();
        return div;
    }

    function updateAllLabels() {
        document.querySelectorAll('.level-container').forEach((l1, i) => {
            l1.querySelector('.l1-label').innerText = `${chineseNums[i]}ã€`;
            l1.querySelectorAll('.sub-level-box').forEach((l2, j) => {
                l2.querySelector('.l2-label').innerText = `(${chineseNums[j]})`;
                l2.querySelectorAll('.l3-input').forEach((l3, k) => { l3.previousElementSibling.innerText = `${k+1}.`; });
            });
        });
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const select = document.getElementById('scenarioSelect');
        select.innerHTML = '<option value="">-- æ‰‹å‹•é—œéµå­—æ’°å¯« --</option>';
        scenarios[mode].forEach((s, i) => select.innerHTML += `<option value="${i}">${s.title}</option>`);
    }

    function applyScenario() {
        const idx = document.getElementById('scenarioSelect').value;
        if (idx === "") return;
        const s = scenarios[currentMode][idx];
        document.getElementById('subjectInp').value = s.sub;
        document.getElementById('l1-root').innerHTML = ""; 
        s.data.forEach(d1 => {
            const l1Div = addL1(d1.l1);
            d1.l2.forEach(d2 => {
                const l2Div = addL2(l1Div.querySelector('.btn-l2'), d2.l2);
                d2.l3.forEach(d3 => addL3(l2Div.querySelector('.btn-l3'), d3));
            });
        });
    }

    function generateDoc() {
        const proj = document.getElementById('projectName').value;
        const recipient = document.getElementById('recipient').value || "å—æ–‡è€…";
        const ref = document.getElementById('refNum').value;
        const subK = document.getElementById('subjectInp').value;
        const year = new Date().getFullYear()-1911;
        let bodyText = "";
        document.querySelectorAll('.level-container').forEach((l1, i) => {
            const val = l1.querySelector('.l1-input').value;
            if(val) {
                bodyText += `\n${chineseNums[i]}ã€${val}`;
                l1.querySelectorAll('.sub-level-box').forEach((l2, j) => {
                    const val2 = l2.querySelector('.l2-input').value;
                    if(val2) {
                        bodyText += `\n    (${chineseNums[j]})${val2}`;
                        l2.querySelectorAll('.l3-input').forEach((l3, k) => { if(l3.value) bodyText += `\n        ${k+1}.${l3.value}`; });
                    }
                });
            }
        });
        const subject = (currentMode === 'up') ? `æœ‰é—œã€Œ${proj}ã€${subK}æ¡ˆï¼Œå ±è«‹  é‘’æ ¸ã€‚` : `æœ‰é—œã€Œ${proj}ã€${subK}æ¡ˆï¼Œè«‹  æŸ¥ç…§ã€‚`;
        const res = `ç™¼æ–‡è€…ï¼šæƒ‡é™½å·¥ç¨‹é¡§å•æœ‰é™å…¬å¸\nç™¼æ–‡æ—¥æœŸï¼šä¸­è¯æ°‘åœ‹ ${year}å¹´${new Date().getMonth()+1}æœˆ${new Date().getDate()}æ—¥\nç™¼æ–‡å­—è™Ÿï¼šæƒ‡é™½ç›£å­—ç¬¬${year}0001è™Ÿ\nå—æ–‡è€…ï¼š${recipient}\n\nä¸»æ—¨ï¼š${subject}\n\nèªªæ˜ï¼š${ref ? '\nä¸€ã€å¾©  è²´å–®ä½'+ref+'è¾¦ç†ã€‚' : ''}${bodyText}`;
        document.getElementById('finalResult').innerText = res;
        document.getElementById('outputArea').style.display = 'block';
    }

    function copyContent() {
        navigator.clipboard.writeText(document.getElementById('finalResult').innerText);
        alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    }

    setMode('up', document.getElementById('modeUp'));
    addL1();
</script>
</body>
</html>
